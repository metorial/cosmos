services:
  consul:
    image: hashicorp/consul:1.17
    command: agent -dev -ui -client=0.0.0.0
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    environment:
      CONSUL_BIND_INTERFACE: eth0
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    volumes:
      - consul_data:/consul/data

  vault:
    image: hashicorp/vault:1.15
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://0.0.0.0:8200"
    ports:
      - "8200:8200"
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    volumes:
      - vault_data:/vault/data

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: cosmos_test
      POSTGRES_USER: cosmos
      POSTGRES_PASSWORD: cosmos_test_password
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cosmos"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data

  controller:
    build:
      context: .
      dockerfile: docker/Dockerfile.controller
    environment:
      COSMOS_HTTP_PORT: 8090
      COSMOS_GRPC_PORT: 9091
      COSMOS_DB_URL: "postgres://cosmos:cosmos_test_password@postgres:5432/cosmos_test?sslmode=disable"
      COSMOS_LOG_LEVEL: debug
      COSMOS_TLS_ENABLED: "false"
      VAULT_ENABLED: "false"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
      CONSUL_ADDR: "consul:8500"
      sentinel_URL: "http://mock-command-core:8080"
      NOMAD_ADDR: "http://mock-nomad:4646"
    ports:
      - "8090:8090"
      - "9091:9091"
    depends_on:
      postgres:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/api/v1/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  agent-1:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    hostname: agent-1
    environment:
      COSMOS_CONTROLLER_URL: "controller:9091"
      COSMOS_DATA_DIR: "/var/lib/cosmos/agent"
      COSMOS_LOG_LEVEL: debug
      COSMOS_TLS_ENABLED: "false"
      VAULT_ENABLED: "false"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
      CONSUL_ADDR: "consul:8500"
      COSMOS_AGENT_RECONCILE_INTERVAL: "10s"
      COSMOS_AGENT_HEARTBEAT_INTERVAL: "10s"
    depends_on:
      controller:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
    volumes:
      - agent1_data:/var/lib/cosmos/agent

  agent-2:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    hostname: agent-2
    environment:
      COSMOS_CONTROLLER_URL: "controller:9091"
      COSMOS_DATA_DIR: "/var/lib/cosmos/agent"
      COSMOS_LOG_LEVEL: debug
      COSMOS_TLS_ENABLED: "false"
      VAULT_ENABLED: "false"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
      CONSUL_ADDR: "consul:8500"
      COSMOS_AGENT_RECONCILE_INTERVAL: "10s"
      COSMOS_AGENT_HEARTBEAT_INTERVAL: "10s"
    depends_on:
      controller:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
    volumes:
      - agent2_data:/var/lib/cosmos/agent

  agent-3:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    hostname: agent-3
    environment:
      COSMOS_CONTROLLER_URL: "controller:9091"
      COSMOS_DATA_DIR: "/var/lib/cosmos/agent"
      COSMOS_LOG_LEVEL: debug
      COSMOS_TLS_ENABLED: "false"
      VAULT_ENABLED: "false"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "root"
      CONSUL_ADDR: "consul:8500"
      COSMOS_AGENT_RECONCILE_INTERVAL: "10s"
      COSMOS_AGENT_HEARTBEAT_INTERVAL: "10s"
    depends_on:
      controller:
        condition: service_healthy
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
    volumes:
      - agent3_data:/var/lib/cosmos/agent

  e2e-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.e2e-tests
    environment:
      COSMOS_CONTROLLER_URL: "http://controller:8090"
      POSTGRES_URL: "postgres://cosmos:cosmos_test_password@postgres:5432/cosmos_test?sslmode=disable"
    depends_on:
      controller:
        condition: service_healthy
      agent-1:
        condition: service_started
      agent-2:
        condition: service_started
      agent-3:
        condition: service_started
    command: ["sleep", "10"]

volumes:
  consul_data:
  vault_data:
  postgres_data:
  agent1_data:
  agent2_data:
  agent3_data:
